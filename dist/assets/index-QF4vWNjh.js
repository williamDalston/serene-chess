import*as ot from"https://cdn.skypack.dev/tone";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const i of n)if(i.type==="childList")for(const u of i.addedNodes)u.tagName==="LINK"&&u.rel==="modulepreload"&&s(u)}).observe(document,{childList:!0,subtree:!0});function e(n){const i={};return n.integrity&&(i.integrity=n.integrity),n.referrerPolicy&&(i.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?i.credentials="include":n.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function s(n){if(n.ep)return;n.ep=!0;const i=e(n);fetch(n.href,i)}})();class ts{constructor(){this.worker=new Worker("./engine/stockfish.js"),this.isReady=!1,this.onReady=null,this.onBestMove=null,this.onInfo=null,this.onError=null,this.setupWorkerListeners(),this.initialize()}setupWorkerListeners(){this.worker.onmessage=t=>{const e=t.data;if(e==="uciok")this.worker.postMessage("isready");else if(e==="readyok")this.isReady||(this.isReady=!0,this.onReady&&this.onReady());else if(e.startsWith("bestmove")){const s=e.split(" ")[1];this.onBestMove&&this.onBestMove(s)}else if(e.startsWith("info")&&this.onInfo){const s=this.parseInfoMessage(e);this.onInfo(s)}},this.worker.onerror=t=>{console.error("[ENGINE ERROR]",t),this.onError&&this.onError(t)}}parseInfoMessage(t){const e={},s=t.split(" ");let n=null;for(let i=1;i<s.length;i++){const u=s[i];if(["depth","seldepth","time","nodes","nps","hashfull","tbhits"].includes(u))n=u,s[i+1]&&(e[n]=parseInt(s[i+1],10),i++);else if(u==="score"){const d=s[i+1],p=parseInt(s[i+2],10);e.score={type:d,value:d==="cp"?p/100:p},i+=2}else if(u==="pv"){e.pv=s.slice(i+1).join(" ");break}}return e}sendCommand(t){this.worker.postMessage(t)}initialize(){this.sendCommand("uci")}setPosition(t){this.sendCommand(`position ${t}`)}goDepth(t){this.sendCommand(`go depth ${t}`)}goTime(t){this.sendCommand(`go movetime ${t}`)}stop(){this.sendCommand("stop")}newGame(){this.sendCommand("ucinewgame"),this.sendCommand("isready")}setOption(t,e){this.sendCommand(`setoption name ${t} value ${e}`)}terminate(){this.worker.terminate()}}function ss(h){return h!==null?{comment:h,variations:[]}:{variations:[]}}function ns(h,t,e,s,n){const i={move:h,variations:n};return t&&(i.suffix=t),e&&(i.nag=e),s!==null&&(i.comment=s),i}function is(...h){const[t,...e]=h;let s=t;for(const n of e)n!==null&&(s.variations=[n,...n.variations],n.variations=[],s=n);return t}function rs(h,t){if(t.marker&&t.marker.comment){let e=t.root;for(;;){const s=e.variations[0];if(!s){e.comment=t.marker.comment;break}e=s}}return{headers:h,root:t.root,result:(t.marker&&t.marker.result)??void 0}}function os(h,t){function e(){this.constructor=h}e.prototype=t.prototype,h.prototype=new e}function Pe(h,t,e,s){var n=Error.call(this,h);return Object.setPrototypeOf&&Object.setPrototypeOf(n,Pe.prototype),n.expected=t,n.found=e,n.location=s,n.name="SyntaxError",n}os(Pe,Error);function At(h,t,e){return e=e||" ",h.length>t?h:(t-=h.length,e+=e.repeat(t),h+e.slice(0,t))}Pe.prototype.format=function(h){var t="Error: "+this.message;if(this.location){var e=null,s;for(s=0;s<h.length;s++)if(h[s].source===this.location.source){e=h[s].text.split(/\r\n|\n|\r/g);break}var n=this.location.start,i=this.location.source&&typeof this.location.source.offset=="function"?this.location.source.offset(n):n,u=this.location.source+":"+i.line+":"+i.column;if(e){var d=this.location.end,p=At("",i.line.toString().length," "),g=e[n.line-1],b=n.line===d.line?d.column:g.length+1,$=b-n.column||1;t+=`
 --> `+u+`
`+p+` |
`+i.line+" | "+g+`
`+p+" | "+At("",n.column-1," ")+At("",$,"^")}else t+=`
 at `+u}return t};Pe.buildMessage=function(h,t){var e={literal:function(g){return'"'+n(g.text)+'"'},class:function(g){var b=g.parts.map(function($){return Array.isArray($)?i($[0])+"-"+i($[1]):i($)});return"["+(g.inverted?"^":"")+b.join("")+"]"},any:function(){return"any character"},end:function(){return"end of input"},other:function(g){return g.description}};function s(g){return g.charCodeAt(0).toString(16).toUpperCase()}function n(g){return g.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(b){return"\\x0"+s(b)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(b){return"\\x"+s(b)})}function i(g){return g.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(b){return"\\x0"+s(b)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(b){return"\\x"+s(b)})}function u(g){return e[g.type](g)}function d(g){var b=g.map(u),$,_;if(b.sort(),b.length>0){for($=1,_=1;$<b.length;$++)b[$-1]!==b[$]&&(b[_]=b[$],_++);b.length=_}switch(b.length){case 1:return b[0];case 2:return b[0]+" or "+b[1];default:return b.slice(0,-1).join(", ")+", or "+b[b.length-1]}}function p(g){return g?'"'+n(g)+'"':"end of input"}return"Expected "+d(h)+" but "+p(t)+" found."};function as(h,t){t=t!==void 0?t:{};var e={},s=t.grammarSource,n={pgn:ve},i=ve,u="[",d='"',p="]",g=".",b="O-O-O",$="O-O",_="0-0-0",y="0-0",M="$",I="{",Z="}",ue=";",Oe="(",q=")",ne="1-0",D="0-1",ie="1/2-1/2",he="*",ee=/^[a-zA-Z]/,Ce=/^[^"]/,Se=/^[0-9]/,de=/^[.]/,te=/^[a-zA-Z1-8\-=]/,re=/^[+#]/,X=/^[!?]/,oe=/^[^}]/,ae=/^[^\r\n]/,He=/^[ \t\r\n]/,ht=A("tag pair"),dt=v("[",!1),We=v('"',!1),je=v("]",!1),gt=A("tag name"),Ne=S([["a","z"],["A","Z"]],!1,!1),pt=A("tag value"),qe=S(['"'],!0,!1),ke=A("move number"),ge=S([["0","9"]],!1,!1),we=v(".",!1),pe=S(["."],!1,!1),$e=A("standard algebraic notation"),me=v("O-O-O",!1),Te=v("O-O",!1),ze=v("0-0-0",!1),W=v("0-0",!1),V=S([["a","z"],["A","Z"],["1","8"],"-","="],!1,!1),Ae=S(["+","#"],!1,!1),B=A("suffix annotation"),Re=S(["!","?"],!1,!1),mt=A("NAG"),Ve=v("$",!1),Le=A("brace comment"),Ye=v("{",!1),Ie=S(["}"],!0,!1),Je=v("}",!1),_e=A("rest of line comment"),Be=v(";",!1),K=S(["\r",`
`],!0,!1),_t=A("variation"),vt=v("(",!1),Et=v(")",!1),yt=A("game termination marker"),bt=v("1-0",!1),Ze=v("0-1",!1),Ct=v("1/2-1/2",!1),St=v("*",!1),Ke=A("whitespace"),Xe=S([" ","	","\r",`
`],!1,!1),kt=function(r,l){return rs(r,l)},et=function(r){return Object.fromEntries(r)},tt=function(r,l){return[r,l]},st=function(r,l){return{root:r,marker:l}},Fe=function(r,l){return is(ss(r),...l.flat())},Me=function(r,l,c,C,k){return ns(r,l,c,C,k)},nt=function(r){return r},wt=function(r){return r.replace(/[\r\n]+/g," ")},De=function(r){return r.trim()},xe=function(r){return r},$t=function(r,l){return{result:r,comment:l}},a=t.peg$currPos|0,G=[{line:1,column:1}],Y=a,f=t.peg$maxFailExpected||[],o=t.peg$silentFails|0,E;if(t.startRule){if(!(t.startRule in n))throw new Error(`Can't start parsing from rule "`+t.startRule+'".');i=n[t.startRule]}function v(r,l){return{type:"literal",text:r,ignoreCase:l}}function S(r,l,c){return{type:"class",parts:r,inverted:l,ignoreCase:c}}function P(){return{type:"end"}}function A(r){return{type:"other",description:r}}function z(r){var l=G[r],c;if(l)return l;if(r>=G.length)c=G.length-1;else for(c=r;!G[--c];);for(l=G[c],l={line:l.line,column:l.column};c<r;)h.charCodeAt(c)===10?(l.line++,l.column=1):l.column++,c++;return G[r]=l,l}function L(r,l,c){var C=z(r),k=z(l),x={source:s,start:{offset:r,line:C.line,column:C.column},end:{offset:l,line:k.line,column:k.column}};return x}function m(r){a<Y||(a>Y&&(Y=a,f=[]),f.push(r))}function O(r,l,c){return new Pe(Pe.buildMessage(r,l),r,l,c)}function ve(){var r,l,c;return r=a,l=se(),c=zt(),r=kt(l,c),r}function se(){var r,l,c;for(r=a,l=[],c=Q();c!==e;)l.push(c),c=Q();return c=j(),r=et(l),r}function Q(){var r,l,c,C,k,x,Ee;return o++,r=a,j(),h.charCodeAt(a)===91?(l=u,a++):(l=e,o===0&&m(dt)),l!==e?(j(),c=it(),c!==e?(j(),h.charCodeAt(a)===34?(C=d,a++):(C=e,o===0&&m(We)),C!==e?(k=jt(),h.charCodeAt(a)===34?(x=d,a++):(x=e,o===0&&m(We)),x!==e?(j(),h.charCodeAt(a)===93?(Ee=p,a++):(Ee=e,o===0&&m(je)),Ee!==e?r=tt(c,k):(a=r,r=e)):(a=r,r=e)):(a=r,r=e)):(a=r,r=e)):(a=r,r=e),o--,r===e&&o===0&&m(ht),r}function it(){var r,l,c;if(o++,r=a,l=[],c=h.charAt(a),ee.test(c)?a++:(c=e,o===0&&m(Ne)),c!==e)for(;c!==e;)l.push(c),c=h.charAt(a),ee.test(c)?a++:(c=e,o===0&&m(Ne));else l=e;return l!==e?r=h.substring(r,a):r=l,o--,r===e&&(l=e,o===0&&m(gt)),r}function jt(){var r,l,c;for(o++,r=a,l=[],c=h.charAt(a),Ce.test(c)?a++:(c=e,o===0&&m(qe));c!==e;)l.push(c),c=h.charAt(a),Ce.test(c)?a++:(c=e,o===0&&m(qe));return r=h.substring(r,a),o--,l=e,o===0&&m(pt),r}function zt(){var r,l,c;return r=a,l=Bt(),j(),c=es(),c===e&&(c=null),j(),r=st(l,c),r}function Bt(){var r,l,c,C;for(r=a,l=Tt(),l===e&&(l=null),c=[],C=Kt();C!==e;)c.push(C),C=Kt();return r=Fe(l,c),r}function Kt(){var r,l,c,C,k,x,Ee,rt;if(r=a,j(),Vt(),j(),l=Yt(),l!==e){for(c=Jt(),c===e&&(c=null),C=[],k=Ft();k!==e;)C.push(k),k=Ft();for(k=j(),x=Tt(),x===e&&(x=null),Ee=[],rt=Dt();rt!==e;)Ee.push(rt),rt=Dt();r=Me(l,c,C,x,Ee)}else a=r,r=e;return r}function Vt(){var r,l,c,C,k,x;for(o++,r=a,l=[],c=h.charAt(a),Se.test(c)?a++:(c=e,o===0&&m(ge));c!==e;)l.push(c),c=h.charAt(a),Se.test(c)?a++:(c=e,o===0&&m(ge));if(h.charCodeAt(a)===46?(c=g,a++):(c=e,o===0&&m(we)),c!==e){for(C=j(),k=[],x=h.charAt(a),de.test(x)?a++:(x=e,o===0&&m(pe));x!==e;)k.push(x),x=h.charAt(a),de.test(x)?a++:(x=e,o===0&&m(pe));l=[l,c,C,k],r=l}else a=r,r=e;return o--,r===e&&(l=e,o===0&&m(ke)),r}function Yt(){var r,l,c,C,k,x;if(o++,r=a,l=a,h.substr(a,5)===b?(c=b,a+=5):(c=e,o===0&&m(me)),c===e&&(h.substr(a,3)===$?(c=$,a+=3):(c=e,o===0&&m(Te)),c===e&&(h.substr(a,5)===_?(c=_,a+=5):(c=e,o===0&&m(ze)),c===e&&(h.substr(a,3)===y?(c=y,a+=3):(c=e,o===0&&m(W)),c===e))))if(c=a,C=h.charAt(a),ee.test(C)?a++:(C=e,o===0&&m(Ne)),C!==e){if(k=[],x=h.charAt(a),te.test(x)?a++:(x=e,o===0&&m(V)),x!==e)for(;x!==e;)k.push(x),x=h.charAt(a),te.test(x)?a++:(x=e,o===0&&m(V));else k=e;k!==e?(C=[C,k],c=C):(a=c,c=e)}else a=c,c=e;return c!==e?(C=h.charAt(a),re.test(C)?a++:(C=e,o===0&&m(Ae)),C===e&&(C=null),c=[c,C],l=c):(a=l,l=e),l!==e?r=h.substring(r,a):r=l,o--,r===e&&(l=e,o===0&&m($e)),r}function Jt(){var r,l,c;for(o++,r=a,l=[],c=h.charAt(a),X.test(c)?a++:(c=e,o===0&&m(Re));c!==e;)l.push(c),l.length>=2?c=e:(c=h.charAt(a),X.test(c)?a++:(c=e,o===0&&m(Re)));return l.length<1?(a=r,r=e):r=l,o--,r===e&&(l=e,o===0&&m(B)),r}function Ft(){var r,l,c,C,k;if(o++,r=a,j(),h.charCodeAt(a)===36?(l=M,a++):(l=e,o===0&&m(Ve)),l!==e){if(c=a,C=[],k=h.charAt(a),Se.test(k)?a++:(k=e,o===0&&m(ge)),k!==e)for(;k!==e;)C.push(k),k=h.charAt(a),Se.test(k)?a++:(k=e,o===0&&m(ge));else C=e;C!==e?c=h.substring(c,a):c=C,c!==e?r=nt(c):(a=r,r=e)}else a=r,r=e;return o--,r===e&&o===0&&m(mt),r}function Tt(){var r;return r=Zt(),r===e&&(r=Xt()),r}function Zt(){var r,l,c,C,k;if(o++,r=a,h.charCodeAt(a)===123?(l=I,a++):(l=e,o===0&&m(Ye)),l!==e){for(c=a,C=[],k=h.charAt(a),oe.test(k)?a++:(k=e,o===0&&m(Ie));k!==e;)C.push(k),k=h.charAt(a),oe.test(k)?a++:(k=e,o===0&&m(Ie));c=h.substring(c,a),h.charCodeAt(a)===125?(C=Z,a++):(C=e,o===0&&m(Je)),C!==e?r=wt(c):(a=r,r=e)}else a=r,r=e;return o--,r===e&&(l=e,o===0&&m(Le)),r}function Xt(){var r,l,c,C,k;if(o++,r=a,h.charCodeAt(a)===59?(l=ue,a++):(l=e,o===0&&m(Be)),l!==e){for(c=a,C=[],k=h.charAt(a),ae.test(k)?a++:(k=e,o===0&&m(K));k!==e;)C.push(k),k=h.charAt(a),ae.test(k)?a++:(k=e,o===0&&m(K));c=h.substring(c,a),r=De(c)}else a=r,r=e;return o--,r===e&&(l=e,o===0&&m(_e)),r}function Dt(){var r,l,c,C;return o++,r=a,j(),h.charCodeAt(a)===40?(l=Oe,a++):(l=e,o===0&&m(vt)),l!==e?(c=Bt(),c!==e?(j(),h.charCodeAt(a)===41?(C=q,a++):(C=e,o===0&&m(Et)),C!==e?r=xe(c):(a=r,r=e)):(a=r,r=e)):(a=r,r=e),o--,r===e&&o===0&&m(_t),r}function es(){var r,l,c;return o++,r=a,h.substr(a,3)===ne?(l=ne,a+=3):(l=e,o===0&&m(bt)),l===e&&(h.substr(a,3)===D?(l=D,a+=3):(l=e,o===0&&m(Ze)),l===e&&(h.substr(a,7)===ie?(l=ie,a+=7):(l=e,o===0&&m(Ct)),l===e&&(h.charCodeAt(a)===42?(l=he,a++):(l=e,o===0&&m(St))))),l!==e?(j(),c=Tt(),c===e&&(c=null),r=$t(l,c)):(a=r,r=e),o--,r===e&&(l=e,o===0&&m(yt)),r}function j(){var r,l;for(o++,r=[],l=h.charAt(a),He.test(l)?a++:(l=e,o===0&&m(Xe));l!==e;)r.push(l),l=h.charAt(a),He.test(l)?a++:(l=e,o===0&&m(Xe));return o--,l=e,o===0&&m(Ke),r}if(E=i(),t.peg$library)return{peg$result:E,peg$currPos:a,peg$FAILED:e,peg$maxFailExpected:f,peg$maxFailPos:Y};if(E!==e&&a===h.length)return E;throw E!==e&&a<h.length&&m(P()),O(f,Y<h.length?h.charAt(Y):null,Y<h.length?L(Y,Y+1):L(Y,Y))}/**
 * @license
 * Copyright (c) 2025, Jeff Hlywa (jhlywa@gmail.com)
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are met:
 *
 * 1. Redistributions of source code must retain the above copyright notice,
 *    this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright notice,
 *    this list of conditions and the following disclaimer in the documentation
 *    and/or other materials provided with the distribution.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
 * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
 * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE
 * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
 * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
 * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
 * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
 * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
 * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
 * POSSIBILITY OF SUCH DAMAGE.
 */const ct=0xffffffffffffffffn;function Lt(h,t){return(h<<t|h>>64n-t)&0xffffffffffffffffn}function Ut(h,t){return h*t&ct}function ls(h){return function(){let t=BigInt(h&ct),e=BigInt(h>>64n&ct);const s=Ut(Lt(Ut(t,5n),7n),9n);return e^=t,t=(Lt(t,24n)^e^e<<16n)&ct,e=Lt(e,37n),h=e<<64n|t,s}}const ut=ls(0xa187eb39cdcaed8f31c4b365b102e01en),cs=Array.from({length:2},()=>Array.from({length:6},()=>Array.from({length:128},()=>ut()))),fs=Array.from({length:8},()=>ut()),us=Array.from({length:16},()=>ut()),It=ut(),H="w",J="b",N="p",qt="n",ft="b",Ge="r",fe="q",R="k",Mt="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1";class at{color;from;to;piece;captured;promotion;flags;san;lan;before;after;constructor(t,e){const{color:s,piece:n,from:i,to:u,flags:d,captured:p,promotion:g}=e,b=F(i),$=F(u);this.color=s,this.piece=n,this.from=b,this.to=$,this.san=t._moveToSan(e,t._moves({legal:!0})),this.lan=b+$,this.before=t.fen(),t._makeMove(e),this.after=t.fen(),t._undoMove(),this.flags="";for(const _ in T)T[_]&d&&(this.flags+=ye[_]);p&&(this.captured=p),g&&(this.promotion=g,this.lan+=g)}isCapture(){return this.flags.indexOf(ye.CAPTURE)>-1}isPromotion(){return this.flags.indexOf(ye.PROMOTION)>-1}isEnPassant(){return this.flags.indexOf(ye.EP_CAPTURE)>-1}isKingsideCastle(){return this.flags.indexOf(ye.KSIDE_CASTLE)>-1}isQueensideCastle(){return this.flags.indexOf(ye.QSIDE_CASTLE)>-1}isBigPawn(){return this.flags.indexOf(ye.BIG_PAWN)>-1}}const U=-1,ye={NORMAL:"n",CAPTURE:"c",BIG_PAWN:"b",EP_CAPTURE:"e",PROMOTION:"p",KSIDE_CASTLE:"k",QSIDE_CASTLE:"q",NULL_MOVE:"-"},T={NORMAL:1,CAPTURE:2,BIG_PAWN:4,EP_CAPTURE:8,PROMOTION:16,KSIDE_CASTLE:32,QSIDE_CASTLE:64,NULL_MOVE:128},Rt={Event:"?",Site:"?",Date:"????.??.??",Round:"?",White:"?",Black:"?",Result:"*"},hs={WhiteTitle:null,BlackTitle:null,WhiteElo:null,BlackElo:null,WhiteUSCF:null,BlackUSCF:null,WhiteNA:null,BlackNA:null,WhiteType:null,BlackType:null,EventDate:null,EventSponsor:null,Section:null,Stage:null,Board:null,Opening:null,Variation:null,SubVariation:null,ECO:null,NIC:null,Time:null,UTCTime:null,UTCDate:null,TimeControl:null,SetUp:null,FEN:null,Termination:null,Annotator:null,Mode:null,PlyCount:null},ds={...Rt,...hs},w={a8:0,b8:1,c8:2,d8:3,e8:4,f8:5,g8:6,h8:7,a7:16,b7:17,c7:18,d7:19,e7:20,f7:21,g7:22,h7:23,a6:32,b6:33,c6:34,d6:35,e6:36,f6:37,g6:38,h6:39,a5:48,b5:49,c5:50,d5:51,e5:52,f5:53,g5:54,h5:55,a4:64,b4:65,c4:66,d4:67,e4:68,f4:69,g4:70,h4:71,a3:80,b3:81,c3:82,d3:83,e3:84,f3:85,g3:86,h3:87,a2:96,b2:97,c2:98,d2:99,e2:100,f2:101,g2:102,h2:103,a1:112,b1:113,c1:114,d1:115,e1:116,f1:117,g1:118,h1:119},xt={b:[16,32,17,15],w:[-16,-32,-17,-15]},Gt={n:[-18,-33,-31,-14,18,33,31,14],b:[-17,-15,17,15],r:[-16,1,16,-1],q:[-17,-16,-15,1,17,16,15,-1],k:[-17,-16,-15,1,17,16,15,-1]},gs=[20,0,0,0,0,0,0,24,0,0,0,0,0,0,20,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,24,24,24,24,24,24,56,0,56,24,24,24,24,24,24,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,20,0,0,0,0,0,0,24,0,0,0,0,0,0,20],ps=[17,0,0,0,0,0,0,16,0,0,0,0,0,0,15,0,0,17,0,0,0,0,0,16,0,0,0,0,0,15,0,0,0,0,17,0,0,0,0,16,0,0,0,0,15,0,0,0,0,0,0,17,0,0,0,16,0,0,0,15,0,0,0,0,0,0,0,0,17,0,0,16,0,0,15,0,0,0,0,0,0,0,0,0,0,17,0,16,0,15,0,0,0,0,0,0,0,0,0,0,0,0,17,16,15,0,0,0,0,0,0,0,1,1,1,1,1,1,1,0,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,-15,-16,-17,0,0,0,0,0,0,0,0,0,0,0,0,-15,0,-16,0,-17,0,0,0,0,0,0,0,0,0,0,-15,0,0,-16,0,0,-17,0,0,0,0,0,0,0,0,-15,0,0,0,-16,0,0,0,-17,0,0,0,0,0,0,-15,0,0,0,0,-16,0,0,0,0,-17,0,0,0,0,-15,0,0,0,0,0,-16,0,0,0,0,0,-17,0,0,-15,0,0,0,0,0,0,-16,0,0,0,0,0,0,-17],ms={p:1,n:2,b:4,r:8,q:16,k:32},_s="pnbrqkPNBRQK",Qt=[qt,ft,Ge,fe],vs=7,Es=6,ys=1,bs=0,lt={[R]:T.KSIDE_CASTLE,[fe]:T.QSIDE_CASTLE},le={w:[{square:w.a1,flag:T.QSIDE_CASTLE},{square:w.h1,flag:T.KSIDE_CASTLE}],b:[{square:w.a8,flag:T.QSIDE_CASTLE},{square:w.h8,flag:T.KSIDE_CASTLE}]},Cs={b:ys,w:Es},Pt="--";function be(h){return h>>4}function Qe(h){return h&15}function Wt(h){return"0123456789".indexOf(h)!==-1}function F(h){const t=Qe(h),e=be(h);return"abcdefgh".substring(t,t+1)+"87654321".substring(e,e+1)}function Ue(h){return h===H?J:H}function Ss(h){const t=h.split(/\s+/);if(t.length!==6)return{ok:!1,error:"Invalid FEN: must contain six space-delimited fields"};const e=parseInt(t[5],10);if(isNaN(e)||e<=0)return{ok:!1,error:"Invalid FEN: move number must be a positive integer"};const s=parseInt(t[4],10);if(isNaN(s)||s<0)return{ok:!1,error:"Invalid FEN: half move counter number must be a non-negative integer"};if(!/^(-|[abcdefgh][36])$/.test(t[3]))return{ok:!1,error:"Invalid FEN: en-passant square is invalid"};if(/[^kKqQ-]/.test(t[2]))return{ok:!1,error:"Invalid FEN: castling availability is invalid"};if(!/^(w|b)$/.test(t[1]))return{ok:!1,error:"Invalid FEN: side-to-move is invalid"};const n=t[0].split("/");if(n.length!==8)return{ok:!1,error:"Invalid FEN: piece data does not contain 8 '/'-delimited rows"};for(let u=0;u<n.length;u++){let d=0,p=!1;for(let g=0;g<n[u].length;g++)if(Wt(n[u][g])){if(p)return{ok:!1,error:"Invalid FEN: piece data is invalid (consecutive number)"};d+=parseInt(n[u][g],10),p=!0}else{if(!/^[prnbqkPRNBQK]$/.test(n[u][g]))return{ok:!1,error:"Invalid FEN: piece data is invalid (invalid piece)"};d+=1,p=!1}if(d!==8)return{ok:!1,error:"Invalid FEN: piece data is invalid (too many squares in rank)"}}if(t[3][1]=="3"&&t[1]=="w"||t[3][1]=="6"&&t[1]=="b")return{ok:!1,error:"Invalid FEN: illegal en-passant square"};const i=[{color:"white",regex:/K/g},{color:"black",regex:/k/g}];for(const{color:u,regex:d}of i){if(!d.test(t[0]))return{ok:!1,error:`Invalid FEN: missing ${u} king`};if((t[0].match(d)||[]).length>1)return{ok:!1,error:`Invalid FEN: too many ${u} kings`}}return Array.from(n[0]+n[7]).some(u=>u.toUpperCase()==="P")?{ok:!1,error:"Invalid FEN: some pawns are on the edge rows"}:{ok:!0}}function ks(h,t){const e=h.from,s=h.to,n=h.piece;let i=0,u=0,d=0;for(let p=0,g=t.length;p<g;p++){const b=t[p].from,$=t[p].to,_=t[p].piece;n===_&&e!==b&&s===$&&(i++,be(e)===be(b)&&u++,Qe(e)===Qe(b)&&d++)}return i>0?u>0&&d>0?F(e):d>0?F(e).charAt(1):F(e).charAt(0):""}function ce(h,t,e,s,n,i=void 0,u=T.NORMAL){const d=be(s);if(n===N&&(d===vs||d===bs))for(let p=0;p<Qt.length;p++){const g=Qt[p];h.push({color:t,from:e,to:s,piece:n,captured:i,promotion:g,flags:u|T.PROMOTION})}else h.push({color:t,from:e,to:s,piece:n,captured:i,flags:u})}function Ht(h){let t=h.charAt(0);return t>="a"&&t<="h"?h.match(/[a-h]\d.*[a-h]\d/)?void 0:N:(t=t.toLowerCase(),t==="o"?R:t)}function Ot(h){return h.replace(/=/,"").replace(/[+#]?[?!]*$/,"")}class Nt{_board=new Array(128);_turn=H;_header={};_kings={w:U,b:U};_epSquare=-1;_halfMoves=0;_moveNumber=0;_history=[];_comments={};_castling={w:0,b:0};_hash=0n;_positionCount=new Map;constructor(t=Mt,{skipValidation:e=!1}={}){this.load(t,{skipValidation:e})}clear({preserveHeaders:t=!1}={}){this._board=new Array(128),this._kings={w:U,b:U},this._turn=H,this._castling={w:0,b:0},this._epSquare=U,this._halfMoves=0,this._moveNumber=1,this._history=[],this._comments={},this._header=t?this._header:{...ds},this._hash=this._computeHash(),this._positionCount=new Map,this._header.SetUp=null,this._header.FEN=null}load(t,{skipValidation:e=!1,preserveHeaders:s=!1}={}){let n=t.split(/\s+/);if(n.length>=2&&n.length<6){const d=["-","-","0","1"];t=n.concat(d.slice(-(6-n.length))).join(" ")}if(n=t.split(/\s+/),!e){const{ok:d,error:p}=Ss(t);if(!d)throw new Error(p)}const i=n[0];let u=0;this.clear({preserveHeaders:s});for(let d=0;d<i.length;d++){const p=i.charAt(d);if(p==="/")u+=8;else if(Wt(p))u+=parseInt(p,10);else{const g=p<"a"?H:J;this._put({type:p.toLowerCase(),color:g},F(u)),u++}}this._turn=n[1],n[2].indexOf("K")>-1&&(this._castling.w|=T.KSIDE_CASTLE),n[2].indexOf("Q")>-1&&(this._castling.w|=T.QSIDE_CASTLE),n[2].indexOf("k")>-1&&(this._castling.b|=T.KSIDE_CASTLE),n[2].indexOf("q")>-1&&(this._castling.b|=T.QSIDE_CASTLE),this._epSquare=n[3]==="-"?U:w[n[3]],this._halfMoves=parseInt(n[4],10),this._moveNumber=parseInt(n[5],10),this._hash=this._computeHash(),this._updateSetup(t),this._incPositionCount()}fen({forceEnpassantSquare:t=!1}={}){let e=0,s="";for(let u=w.a8;u<=w.h1;u++){if(this._board[u]){e>0&&(s+=e,e=0);const{color:d,type:p}=this._board[u];s+=d===H?p.toUpperCase():p.toLowerCase()}else e++;u+1&136&&(e>0&&(s+=e),u!==w.h1&&(s+="/"),e=0,u+=8)}let n="";this._castling[H]&T.KSIDE_CASTLE&&(n+="K"),this._castling[H]&T.QSIDE_CASTLE&&(n+="Q"),this._castling[J]&T.KSIDE_CASTLE&&(n+="k"),this._castling[J]&T.QSIDE_CASTLE&&(n+="q"),n=n||"-";let i="-";if(this._epSquare!==U)if(t)i=F(this._epSquare);else{const u=this._epSquare+(this._turn===H?16:-16),d=[u+1,u-1];for(const p of d){if(p&136)continue;const g=this._turn;if(this._board[p]?.color===g&&this._board[p]?.type===N){this._makeMove({color:g,from:p,to:this._epSquare,piece:N,captured:N,flags:T.EP_CAPTURE});const b=!this._isKingAttacked(g);if(this._undoMove(),b){i=F(this._epSquare);break}}}}return[s,this._turn,n,i,this._halfMoves,this._moveNumber].join(" ")}_pieceKey(t){if(!this._board[t])return 0n;const{color:e,type:s}=this._board[t],n={w:0,b:1}[e],i={p:0,n:1,b:2,r:3,q:4,k:5}[s];return cs[n][i][t]}_epKey(){return this._epSquare===U?0n:fs[this._epSquare&7]}_castlingKey(){const t=this._castling.w>>5|this._castling.b>>3;return us[t]}_computeHash(){let t=0n;for(let e=w.a8;e<=w.h1;e++){if(e&136){e+=7;continue}this._board[e]&&(t^=this._pieceKey(e))}return t^=this._epKey(),t^=this._castlingKey(),this._turn==="b"&&(t^=It),t}_updateSetup(t){this._history.length>0||(t!==Mt?(this._header.SetUp="1",this._header.FEN=t):(this._header.SetUp=null,this._header.FEN=null))}reset(){this.load(Mt)}get(t){return this._board[w[t]]}findPiece(t){const e=[];for(let s=w.a8;s<=w.h1;s++){if(s&136){s+=7;continue}!this._board[s]||this._board[s]?.color!==t.color||this._board[s].color===t.color&&this._board[s].type===t.type&&e.push(F(s))}return e}put({type:t,color:e},s){return this._put({type:t,color:e},s)?(this._updateCastlingRights(),this._updateEnPassantSquare(),this._updateSetup(this.fen()),!0):!1}_set(t,e){this._hash^=this._pieceKey(t),this._board[t]=e,this._hash^=this._pieceKey(t)}_put({type:t,color:e},s){if(_s.indexOf(t.toLowerCase())===-1||!(s in w))return!1;const n=w[s];if(t==R&&!(this._kings[e]==U||this._kings[e]==n))return!1;const i=this._board[n];return i&&i.type===R&&(this._kings[i.color]=U),this._set(n,{type:t,color:e}),t===R&&(this._kings[e]=n),!0}_clear(t){this._hash^=this._pieceKey(t),delete this._board[t]}remove(t){const e=this.get(t);return this._clear(w[t]),e&&e.type===R&&(this._kings[e.color]=U),this._updateCastlingRights(),this._updateEnPassantSquare(),this._updateSetup(this.fen()),e}_updateCastlingRights(){this._hash^=this._castlingKey();const t=this._board[w.e1]?.type===R&&this._board[w.e1]?.color===H,e=this._board[w.e8]?.type===R&&this._board[w.e8]?.color===J;(!t||this._board[w.a1]?.type!==Ge||this._board[w.a1]?.color!==H)&&(this._castling.w&=-65),(!t||this._board[w.h1]?.type!==Ge||this._board[w.h1]?.color!==H)&&(this._castling.w&=-33),(!e||this._board[w.a8]?.type!==Ge||this._board[w.a8]?.color!==J)&&(this._castling.b&=-65),(!e||this._board[w.h8]?.type!==Ge||this._board[w.h8]?.color!==J)&&(this._castling.b&=-33),this._hash^=this._castlingKey()}_updateEnPassantSquare(){if(this._epSquare===U)return;const t=this._epSquare+(this._turn===H?-16:16),e=this._epSquare+(this._turn===H?16:-16),s=[e+1,e-1];if(this._board[t]!==null||this._board[this._epSquare]!==null||this._board[e]?.color!==Ue(this._turn)||this._board[e]?.type!==N){this._hash^=this._epKey(),this._epSquare=U;return}const n=i=>!(i&136)&&this._board[i]?.color===this._turn&&this._board[i]?.type===N;s.some(n)||(this._hash^=this._epKey(),this._epSquare=U)}_attacked(t,e,s){const n=[];for(let i=w.a8;i<=w.h1;i++){if(i&136){i+=7;continue}if(this._board[i]===void 0||this._board[i].color!==t)continue;const u=this._board[i],d=i-e;if(d===0)continue;const p=d+119;if(gs[p]&ms[u.type]){if(u.type===N){if(d>0&&u.color===H||d<=0&&u.color===J)if(s)n.push(F(i));else return!0;continue}if(u.type==="n"||u.type==="k")if(s){n.push(F(i));continue}else return!0;const g=ps[p];let b=i+g,$=!1;for(;b!==e;){if(this._board[b]!=null){$=!0;break}b+=g}if(!$)if(s){n.push(F(i));continue}else return!0}}return s?n:!1}attackers(t,e){return e?this._attacked(e,w[t],!0):this._attacked(this._turn,w[t],!0)}_isKingAttacked(t){const e=this._kings[t];return e===-1?!1:this._attacked(Ue(t),e)}hash(){return this._hash.toString(16)}isAttacked(t,e){return this._attacked(e,w[t])}isCheck(){return this._isKingAttacked(this._turn)}inCheck(){return this.isCheck()}isCheckmate(){return this.isCheck()&&this._moves().length===0}isStalemate(){return!this.isCheck()&&this._moves().length===0}isInsufficientMaterial(){const t={b:0,n:0,r:0,q:0,k:0,p:0},e=[];let s=0,n=0;for(let i=w.a8;i<=w.h1;i++){if(n=(n+1)%2,i&136){i+=7;continue}const u=this._board[i];u&&(t[u.type]=u.type in t?t[u.type]+1:1,u.type===ft&&e.push(n),s++)}if(s===2)return!0;if(s===3&&(t[ft]===1||t[qt]===1))return!0;if(s===t[ft]+2){let i=0;const u=e.length;for(let d=0;d<u;d++)i+=e[d];if(i===0||i===u)return!0}return!1}isThreefoldRepetition(){return this._getPositionCount(this._hash)>=3}isDrawByFiftyMoves(){return this._halfMoves>=100}isDraw(){return this.isDrawByFiftyMoves()||this.isStalemate()||this.isInsufficientMaterial()||this.isThreefoldRepetition()}isGameOver(){return this.isCheckmate()||this.isDraw()}moves({verbose:t=!1,square:e=void 0,piece:s=void 0}={}){const n=this._moves({square:e,piece:s});return t?n.map(i=>new at(this,i)):n.map(i=>this._moveToSan(i,n))}_moves({legal:t=!0,piece:e=void 0,square:s=void 0}={}){const n=s?s.toLowerCase():void 0,i=e?.toLowerCase(),u=[],d=this._turn,p=Ue(d);let g=w.a8,b=w.h1,$=!1;if(n)if(n in w)g=b=w[n],$=!0;else return[];for(let y=g;y<=b;y++){if(y&136){y+=7;continue}if(!this._board[y]||this._board[y].color===p)continue;const{type:M}=this._board[y];let I;if(M===N){if(i&&i!==M)continue;I=y+xt[d][0],this._board[I]||(ce(u,d,y,I,N),I=y+xt[d][1],Cs[d]===be(y)&&!this._board[I]&&ce(u,d,y,I,N,void 0,T.BIG_PAWN));for(let Z=2;Z<4;Z++)I=y+xt[d][Z],!(I&136)&&(this._board[I]?.color===p?ce(u,d,y,I,N,this._board[I].type,T.CAPTURE):I===this._epSquare&&ce(u,d,y,I,N,N,T.EP_CAPTURE))}else{if(i&&i!==M)continue;for(let Z=0,ue=Gt[M].length;Z<ue;Z++){const Oe=Gt[M][Z];for(I=y;I+=Oe,!(I&136);){if(!this._board[I])ce(u,d,y,I,M);else{if(this._board[I].color===d)break;ce(u,d,y,I,M,this._board[I].type,T.CAPTURE);break}if(M===qt||M===R)break}}}}if((i===void 0||i===R)&&(!$||b===this._kings[d])){if(this._castling[d]&T.KSIDE_CASTLE){const y=this._kings[d],M=y+2;!this._board[y+1]&&!this._board[M]&&!this._attacked(p,this._kings[d])&&!this._attacked(p,y+1)&&!this._attacked(p,M)&&ce(u,d,this._kings[d],M,R,void 0,T.KSIDE_CASTLE)}if(this._castling[d]&T.QSIDE_CASTLE){const y=this._kings[d],M=y-2;!this._board[y-1]&&!this._board[y-2]&&!this._board[y-3]&&!this._attacked(p,this._kings[d])&&!this._attacked(p,y-1)&&!this._attacked(p,M)&&ce(u,d,this._kings[d],M,R,void 0,T.QSIDE_CASTLE)}}if(!t||this._kings[d]===-1)return u;const _=[];for(let y=0,M=u.length;y<M;y++)this._makeMove(u[y]),this._isKingAttacked(d)||_.push(u[y]),this._undoMove();return _}move(t,{strict:e=!1}={}){let s=null;if(typeof t=="string")s=this._moveFromSan(t,e);else if(t===null)s=this._moveFromSan(Pt,e);else if(typeof t=="object"){const i=this._moves();for(let u=0,d=i.length;u<d;u++)if(t.from===F(i[u].from)&&t.to===F(i[u].to)&&(!("promotion"in i[u])||t.promotion===i[u].promotion)){s=i[u];break}}if(!s)throw typeof t=="string"?new Error(`Invalid move: ${t}`):new Error(`Invalid move: ${JSON.stringify(t)}`);if(this.isCheck()&&s.flags&T.NULL_MOVE)throw new Error("Null move not allowed when in check");const n=new at(this,s);return this._makeMove(s),this._incPositionCount(),n}_push(t){this._history.push({move:t,kings:{b:this._kings.b,w:this._kings.w},turn:this._turn,castling:{b:this._castling.b,w:this._castling.w},epSquare:this._epSquare,halfMoves:this._halfMoves,moveNumber:this._moveNumber})}_movePiece(t,e){this._hash^=this._pieceKey(t),this._board[e]=this._board[t],delete this._board[t],this._hash^=this._pieceKey(e)}_makeMove(t){const e=this._turn,s=Ue(e);if(this._push(t),t.flags&T.NULL_MOVE){e===J&&this._moveNumber++,this._halfMoves++,this._turn=s,this._epSquare=U;return}if(this._hash^=this._epKey(),this._hash^=this._castlingKey(),t.captured&&(this._hash^=this._pieceKey(t.to)),this._movePiece(t.from,t.to),t.flags&T.EP_CAPTURE&&(this._turn===J?this._clear(t.to-16):this._clear(t.to+16)),t.promotion&&(this._clear(t.to),this._set(t.to,{type:t.promotion,color:e})),this._board[t.to].type===R){if(this._kings[e]=t.to,t.flags&T.KSIDE_CASTLE){const n=t.to-1,i=t.to+1;this._movePiece(i,n)}else if(t.flags&T.QSIDE_CASTLE){const n=t.to+1,i=t.to-2;this._movePiece(i,n)}this._castling[e]=0}if(this._castling[e]){for(let n=0,i=le[e].length;n<i;n++)if(t.from===le[e][n].square&&this._castling[e]&le[e][n].flag){this._castling[e]^=le[e][n].flag;break}}if(this._castling[s]){for(let n=0,i=le[s].length;n<i;n++)if(t.to===le[s][n].square&&this._castling[s]&le[s][n].flag){this._castling[s]^=le[s][n].flag;break}}if(this._hash^=this._castlingKey(),t.flags&T.BIG_PAWN){let n;e===J?n=t.to-16:n=t.to+16,!(t.to-1&136)&&this._board[t.to-1]?.type===N&&this._board[t.to-1]?.color===s||!(t.to+1&136)&&this._board[t.to+1]?.type===N&&this._board[t.to+1]?.color===s?(this._epSquare=n,this._hash^=this._epKey()):this._epSquare=U}else this._epSquare=U;t.piece===N?this._halfMoves=0:t.flags&(T.CAPTURE|T.EP_CAPTURE)?this._halfMoves=0:this._halfMoves++,e===J&&this._moveNumber++,this._turn=s,this._hash^=It}undo(){const t=this._hash,e=this._undoMove();if(e){const s=new at(this,e);return this._decPositionCount(t),s}return null}_undoMove(){const t=this._history.pop();if(t===void 0)return null;this._hash^=this._epKey(),this._hash^=this._castlingKey();const e=t.move;this._kings=t.kings,this._turn=t.turn,this._castling=t.castling,this._epSquare=t.epSquare,this._halfMoves=t.halfMoves,this._moveNumber=t.moveNumber,this._hash^=this._epKey(),this._hash^=this._castlingKey(),this._hash^=It;const s=this._turn,n=Ue(s);if(e.flags&T.NULL_MOVE)return e;if(this._movePiece(e.to,e.from),e.piece&&(this._clear(e.from),this._set(e.from,{type:e.piece,color:s})),e.captured)if(e.flags&T.EP_CAPTURE){let i;s===J?i=e.to-16:i=e.to+16,this._set(i,{type:N,color:n})}else this._set(e.to,{type:e.captured,color:n});if(e.flags&(T.KSIDE_CASTLE|T.QSIDE_CASTLE)){let i,u;e.flags&T.KSIDE_CASTLE?(i=e.to+1,u=e.to-1):(i=e.to-2,u=e.to+1),this._movePiece(u,i)}return e}pgn({newline:t=`
`,maxWidth:e=0}={}){const s=[];let n=!1;for(const _ in this._header)this._header[_]&&s.push(`[${_} "${this._header[_]}"]`+t),n=!0;n&&this._history.length&&s.push(t);const i=_=>{const y=this._comments[this.fen()];if(typeof y<"u"){const M=_.length>0?" ":"";_=`${_}${M}{${y}}`}return _},u=[];for(;this._history.length>0;)u.push(this._undoMove());const d=[];let p="";for(u.length===0&&d.push(i(""));u.length>0;){p=i(p);const _=u.pop();if(!_)break;if(!this._history.length&&_.color==="b"){const y=`${this._moveNumber}. ...`;p=p?`${p} ${y}`:y}else _.color==="w"&&(p.length&&d.push(p),p=this._moveNumber+".");p=p+" "+this._moveToSan(_,this._moves({legal:!0})),this._makeMove(_)}if(p.length&&d.push(i(p)),d.push(this._header.Result||"*"),e===0)return s.join("")+d.join(" ");const g=function(){return s.length>0&&s[s.length-1]===" "?(s.pop(),!0):!1},b=function(_,y){for(const M of y.split(" "))if(M){if(_+M.length>e){for(;g();)_--;s.push(t),_=0}s.push(M),_+=M.length,s.push(" "),_++}return g()&&_--,_};let $=0;for(let _=0;_<d.length;_++){if($+d[_].length>e&&d[_].includes("{")){$=b($,d[_]);continue}$+d[_].length>e&&_!==0?(s[s.length-1]===" "&&s.pop(),s.push(t),$=0):_!==0&&(s.push(" "),$++),s.push(d[_]),$+=d[_].length}return s.join("")}header(...t){for(let e=0;e<t.length;e+=2)typeof t[e]=="string"&&typeof t[e+1]=="string"&&(this._header[t[e]]=t[e+1]);return this._header}setHeader(t,e){return this._header[t]=e??Rt[t]??null,this.getHeaders()}removeHeader(t){return t in this._header?(this._header[t]=Rt[t]||null,!0):!1}getHeaders(){const t={};for(const[e,s]of Object.entries(this._header))s!==null&&(t[e]=s);return t}loadPgn(t,{strict:e=!1,newlineChar:s=`\r?
`}={}){s!==`\r?
`&&(t=t.replace(new RegExp(s,"g"),`
`));const n=as(t);this.reset();const i=n.headers;let u="";for(const g in i)g.toLowerCase()==="fen"&&(u=i[g]),this.header(g,i[g]);if(!e)u&&this.load(u,{preserveHeaders:!0});else if(i.SetUp==="1"){if(!("FEN"in i))throw new Error("Invalid PGN: FEN tag must be supplied with SetUp tag");this.load(i.FEN,{preserveHeaders:!0})}let d=n.root;for(;d;){if(d.move){const g=this._moveFromSan(d.move,e);if(g==null)throw new Error(`Invalid move in PGN: ${d.move}`);this._makeMove(g),this._incPositionCount()}d.comment!==void 0&&(this._comments[this.fen()]=d.comment),d=d.variations[0]}const p=n.result;p&&Object.keys(this._header).length&&this._header.Result!==p&&this.setHeader("Result",p)}_moveToSan(t,e){let s="";if(t.flags&T.KSIDE_CASTLE)s="O-O";else if(t.flags&T.QSIDE_CASTLE)s="O-O-O";else{if(t.flags&T.NULL_MOVE)return Pt;if(t.piece!==N){const n=ks(t,e);s+=t.piece.toUpperCase()+n}t.flags&(T.CAPTURE|T.EP_CAPTURE)&&(t.piece===N&&(s+=F(t.from)[0]),s+="x"),s+=F(t.to),t.promotion&&(s+="="+t.promotion.toUpperCase())}return this._makeMove(t),this.isCheck()&&(this.isCheckmate()?s+="#":s+="+"),this._undoMove(),s}_moveFromSan(t,e=!1){let s=Ot(t);if(e||(s==="0-0"?s="O-O":s==="0-0-0"&&(s="O-O-O")),s==Pt)return{color:this._turn,from:0,to:0,piece:"k",flags:T.NULL_MOVE};let n=Ht(s),i=this._moves({legal:!0,piece:n});for(let _=0,y=i.length;_<y;_++)if(s===Ot(this._moveToSan(i[_],i)))return i[_];if(e)return null;let u,d,p,g,b,$=!1;if(d=s.match(/([pnbrqkPNBRQK])?([a-h][1-8])x?-?([a-h][1-8])([qrbnQRBN])?/),d?(u=d[1],p=d[2],g=d[3],b=d[4],p.length==1&&($=!0)):(d=s.match(/([pnbrqkPNBRQK])?([a-h]?[1-8]?)x?-?([a-h][1-8])([qrbnQRBN])?/),d&&(u=d[1],p=d[2],g=d[3],b=d[4],p.length==1&&($=!0))),n=Ht(s),i=this._moves({legal:!0,piece:u||n}),!g)return null;for(let _=0,y=i.length;_<y;_++)if(p){if((!u||u.toLowerCase()==i[_].piece)&&w[p]==i[_].from&&w[g]==i[_].to&&(!b||b.toLowerCase()==i[_].promotion))return i[_];if($){const M=F(i[_].from);if((!u||u.toLowerCase()==i[_].piece)&&w[g]==i[_].to&&(p==M[0]||p==M[1])&&(!b||b.toLowerCase()==i[_].promotion))return i[_]}}else if(s===Ot(this._moveToSan(i[_],i)).replace("x",""))return i[_];return null}ascii(){let t=`   +------------------------+
`;for(let e=w.a8;e<=w.h1;e++){if(Qe(e)===0&&(t+=" "+"87654321"[be(e)]+" |"),this._board[e]){const s=this._board[e].type,i=this._board[e].color===H?s.toUpperCase():s.toLowerCase();t+=" "+i+" "}else t+=" . ";e+1&136&&(t+=`|
`,e+=8)}return t+=`   +------------------------+
`,t+="     a  b  c  d  e  f  g  h",t}perft(t){const e=this._moves({legal:!1});let s=0;const n=this._turn;for(let i=0,u=e.length;i<u;i++)this._makeMove(e[i]),this._isKingAttacked(n)||(t-1>0?s+=this.perft(t-1):s++),this._undoMove();return s}setTurn(t){return this._turn==t?!1:(this.move("--"),!0)}turn(){return this._turn}board(){const t=[];let e=[];for(let s=w.a8;s<=w.h1;s++)this._board[s]==null?e.push(null):e.push({square:F(s),type:this._board[s].type,color:this._board[s].color}),s+1&136&&(t.push(e),e=[],s+=8);return t}squareColor(t){if(t in w){const e=w[t];return(be(e)+Qe(e))%2===0?"light":"dark"}return null}history({verbose:t=!1}={}){const e=[],s=[];for(;this._history.length>0;)e.push(this._undoMove());for(;;){const n=e.pop();if(!n)break;t?s.push(new at(this,n)):s.push(this._moveToSan(n,this._moves())),this._makeMove(n)}return s}_getPositionCount(t){return this._positionCount.get(t)??0}_incPositionCount(){this._positionCount.set(this._hash,(this._positionCount.get(this._hash)??0)+1)}_decPositionCount(t){const e=this._positionCount.get(t)??0;e===1?this._positionCount.delete(t):this._positionCount.set(t,e-1)}_pruneComments(){const t=[],e={},s=n=>{n in this._comments&&(e[n]=this._comments[n])};for(;this._history.length>0;)t.push(this._undoMove());for(s(this.fen());;){const n=t.pop();if(!n)break;this._makeMove(n),s(this.fen())}this._comments=e}getComment(){return this._comments[this.fen()]}setComment(t){this._comments[this.fen()]=t.replace("{","[").replace("}","]")}deleteComment(){return this.removeComment()}removeComment(){const t=this._comments[this.fen()];return delete this._comments[this.fen()],t}getComments(){return this._pruneComments(),Object.keys(this._comments).map(t=>({fen:t,comment:this._comments[t]}))}deleteComments(){return this.removeComments()}removeComments(){return this._pruneComments(),Object.keys(this._comments).map(t=>{const e=this._comments[t];return delete this._comments[t],{fen:t,comment:e}})}setCastlingRights(t,e){for(const n of[R,fe])e[n]!==void 0&&(e[n]?this._castling[t]|=lt[n]:this._castling[t]&=~lt[n]);this._updateCastlingRights();const s=this.getCastlingRights(t);return(e[R]===void 0||e[R]===s[R])&&(e[fe]===void 0||e[fe]===s[fe])}getCastlingRights(t){return{[R]:(this._castling[t]&lt[R])!==0,[fe]:(this._castling[t]&lt[fe])!==0}}moveNumber(){return this._moveNumber}}console.log("main.js loaded");window.SereneChessLoaded=!0;document.addEventListener("DOMContentLoaded",()=>{const h={p:"pieces/bP.svg",r:"pieces/bR.svg",n:"pieces/bN.svg",b:"pieces/bB.svg",q:"pieces/bQ.svg",k:"pieces/bK.svg",P:"pieces/wP.svg",R:"pieces/wR.svg",N:"pieces/wN.svg",B:"pieces/wB.svg",Q:"pieces/wQ.svg",K:"pieces/wK.svg"},t={p:1,n:3,b:3,r:5,q:9},e={defender:{contempt:-50,name:"Defender: Cautious and solid."},balanced:{contempt:0,name:"Balanced: A neutral, well-rounded style."},aggressor:{contempt:50,name:"Aggressor: Prefers attacking and complications."}},s=new Nt;let n="white",i="w",u=null,d=1800,p=0,g=!1,b=!1,$=!1,_,y=null,M=!1,I=window.innerWidth<=768,Z,ue;const Oe=768;let q=null;const ne=document.getElementById("chessboard"),D=document.getElementById("move-history"),ie=document.getElementById("move-history-toggle"),he=document.querySelector(".evaluation-display"),ee=document.getElementById("evaluation-bar"),Ce=document.getElementById("mate-in-label"),Se=document.getElementById("new-game"),de=document.getElementById("undo-move"),te=document.getElementById("flip-switch-button"),re=document.getElementById("force-move"),X=document.getElementById("promotion-overlay"),oe=X?X.querySelector(".promotion-dialog"):null,ae=document.getElementById("elo-slider"),He=document.getElementById("elo-label-current"),ht=document.querySelectorAll("[data-preset]"),dt=document.getElementById("white-captured"),We=document.getElementById("black-captured"),je=document.getElementById("game-over-overlay"),gt=document.getElementById("game-over-title"),Ne=document.getElementById("game-over-message"),pt=document.getElementById("game-over-new-game"),qe=document.getElementById("settings-icon"),ke=document.getElementById("settings-modal"),ge=document.getElementById("reset-settings"),we=document.getElementById("human-mode-toggle"),pe=document.getElementById("training-mode-toggle"),$e=document.getElementById("sound-toggle"),me=document.getElementById("dark-mode-toggle"),Te=document.querySelectorAll(".panel-section:not(:last-child)"),ze=document.getElementById("engine-indicator"),W=document.getElementById("engine-status"),V=document.getElementById("thinking-indicator"),Ae=2;if(!ne||!D||!he||!ee||!Ce){console.error("Critical UI elements not found in DOM");return}K(s.fen(),n),Ve(),Me(),W.textContent="Loading Engine...",ze.style.backgroundColor="var(--warning)";const B=new ts;B.onReady=()=>{B.setOption("UCI_LimitStrength",!0),Y(),W.textContent="Ready",ze.style.backgroundColor="var(--success)",s.turn()!==i&&!g&&!s.isGameOver()&&Je(!0)},B.onInfo=f=>{f.score&&xe(f.score,s.turn())},B.onBestMove=f=>{const o=s.move(f,{sloppy:!0});o&&(Re(o),u=o),De(),K(s.fen(),n),Fe(),Me(),Be(),Le()},B.onError=f=>console.error("[ENGINE ERROR]",f);function Re(f){b&&typeof window._playMoveSound=="function"&&window._playMoveSound(f)}function mt(){clearTimeout(Z),Z=setTimeout(()=>{const f=I;I=window.innerWidth<=Oe,f!==I&&requestAnimationFrame(()=>{Ve(),K(s.fen(),n)})},150)}function Ve(){I?(ie.classList.add("collapsed"),D.classList.add("collapsed"),D.style.maxHeight="0"):(ie.classList.remove("collapsed"),D.classList.remove("collapsed"),D.style.maxHeight="250px"),he.style.position=I?"relative":"absolute",he.style.order=I?"-1":"initial",Le()}function Le(){const f=document.getElementById("white-captured"),o=document.getElementById("black-captured");f.classList.remove("current-turn"),o.classList.remove("current-turn"),s.turn()==="w"?n==="white"?f.classList.add("current-turn"):o.classList.add("current-turn"):n==="white"?o.classList.add("current-turn"):f.classList.add("current-turn")}function Ye(){te.textContent=`Play as ${i==="w"?"Black":"White"}`}window.addEventListener("resize",mt),ie&&ie.addEventListener("click",()=>{if(I){const f=ie.classList.toggle("collapsed");D.classList.toggle("collapsed",f),D.style.maxHeight=f?"0":D.scrollHeight+"px"}});function Ie(){s.reset(),u=null,B.stop(),B.newGame(),je.style.display="none",Fe(),Me(),Ye(),xe({type:"cp",value:0}),_e()}function Je(f=!1){if(s.isGameOver()||g)return;wt(),B.setPosition("fen "+s.fen());const S=f?500:Math.min(1500,500+(d-1200)*.5);B.goTime(S),clearTimeout(_),_=setTimeout(()=>{V&&V.classList.contains("visible")&&(B.stop(),console.warn("Engine exceeded expected move time. Forcing stop."))},S+200)}function _e(){K(s.fen(),n),De(),!s.isGameOver()&&!$&&(W.textContent="Ready"),s.turn()!==i&&!g&&!s.isGameOver()&&Je(!0),de.disabled=g?s.history().length<1:s.history().length<2,Le()}function Be(){if(!s.isGameOver()||$)return W&&V&&!V.classList.contains("visible")&&(W.textContent="Ready"),!1;let f="Game Over",o="";return s.isCheckmate()?(f="Checkmate!",o=`${s.turn()==="w"?"Black":"White"} wins.`,xe({type:"mate",value:s.turn()==="w"?-1:1})):(f="Draw",o="The game is a draw.",xe({type:"cp",value:0})),gt.textContent=f,Ne.textContent=o,je.style.display="flex",!0}function K(f=s.fen(),o=n){document.querySelectorAll(".square.drag-over").forEach(A=>A.classList.remove("drag-over"));const E=new Nt(f);ne.innerHTML="";const v=o==="white"?[8,7,6,5,4,3,2,1]:[1,2,3,4,5,6,7,8],S=o==="white"?["a","b","c","d","e","f","g","h"]:["h","g","f","e","d","c","b","a"];let P=null;if(E.inCheck()&&E.findKing){const A=E.findKing(E.turn());A&&(P=A.square)}for(const A of v)for(const z of S){const L=z+A,m=E.get(L),O=document.createElement("div");if(O.classList.add("square",(S.indexOf(z)+v.indexOf(A))%2===0?"light":"dark"),O.dataset.square=L,u&&(L===u.from||L===u.to)&&O.classList.add("last-move"),L===P&&O.classList.add("in-check"),y===L&&O.classList.add("selected"),document.getElementById("highlight-moves-toggle")?.checked&&y===L&&E.moves({square:y,verbose:!0}).forEach(Q=>{const it=document.querySelector(`[data-square="${Q.to}"]`);it&&it.classList.add("possible-move")}),O.addEventListener("dragover",Et),O.addEventListener("drop",yt),O.addEventListener("dragleave",se=>se.currentTarget.classList.remove("drag-over")),O.addEventListener("click",()=>St(L)),m){const se=m.color==="w"?m.type.toUpperCase():m.type.toLowerCase(),Q=document.createElement("img");Q.src=h[se],Q.classList.add("chess-piece"),(m.color===i&&!g||g&&m.color===E.turn())&&(Q.draggable=!0,Q.addEventListener("dragstart",_t),Q.addEventListener("dragend",vt),Q.addEventListener("touchstart",bt,{passive:!1}),Q.addEventListener("touchmove",Ze,{passive:!1}),Q.addEventListener("touchend",Ct,{passive:!1})),O.appendChild(Q)}ne.appendChild(O)}X&&!ne.contains(X)&&ne.appendChild(X),Le()}function _t(f){if(s.turn()!==i&&!g){f.preventDefault();return}y=f.target.parentElement.dataset.square,q=f.target,f.dataTransfer.setData("text/plain",y),f.dataTransfer.effectAllowed="move",setTimeout(()=>{q.classList.add("dragging")},0)}function vt(f){q&&q.classList.remove("dragging"),q=null,y=null}function Et(f){f.preventDefault(),f.dataTransfer.dropEffect="move",f.currentTarget.classList.add("drag-over")}function yt(f){f.preventDefault(),f.currentTarget.classList.remove("drag-over"),y&&toSquare&&y!==toSquare?Ke(y,toSquare):K(s.fen(),n)}function bt(f){f.preventDefault(),!(s.turn()!==i&&!g)&&(clearTimeout(ue),ue=setTimeout(()=>{y=f.target.parentElement.dataset.square;const o=f.target,E=o.parentElement.getBoundingClientRect();q=o.cloneNode(!0),Object.assign(q.style,{position:"absolute",zIndex:"1000",pointerEvents:"none",width:`${o.offsetWidth}px`,height:`${o.offsetHeight}px`,left:`${E.left+o.offsetLeft}px`,top:`${E.top+o.offsetTop}px`,filter:"drop-shadow(0 4px 8px rgba(0,0,0,0.4))",transition:"none",cursor:"grabbing"}),document.body.appendChild(q),o.style.opacity="0.3",o.style.cursor="grabbing",Ze(f)},50))}function Ze(f){q&&requestAnimationFrame(()=>{const o=f.touches[0];q.style.left=`${o.pageX-q.offsetWidth/2}px`,q.style.top=`${o.pageY-q.offsetHeight/2}px`})}function Ct(f){if(clearTimeout(ue),!q)return;const o=f.changedTouches[0],E=document.elementFromPoint(o.clientX,o.clientY),v=E?.classList.contains("square")?E.dataset.square:E?.parentElement?.dataset.square,S=document.querySelector(`[data-square="${y}"] .chess-piece`);S&&(S.style.opacity="1",S.style.cursor="grab"),document.body.contains(q)&&document.body.removeChild(q),q=null,y&&v&&y!==v?Ke(y,v):(y=null,K(s.fen(),n))}async function St(f){if(y)await Ke(y,f),y=null,K(s.fen(),n);else{const o=s.get(f);o&&(o.color===i&&!g||g&&o.color===s.turn())&&(y=f,K(s.fen(),n))}}async function Ke(f,o){const E=s.moves({square:f,verbose:!0}).find(S=>S.to===o);if(!E){K(s.fen(),n);return}const v={from:f,to:o};if(E.flags.includes("p"))try{v.promotion=await kt(i)}catch{K(s.fen(),n);return}Xe(v)}function Xe(f){const o=document.querySelector(`[data-square=${f.from}]`),E=document.querySelector(`[data-square=${f.to}]`),v=o.querySelector(".chess-piece");if(!o||!E||!v){const L=s.move(f);L&&(u=L),K(s.fen(),n);return}const S=o.getBoundingClientRect(),P=E.getBoundingClientRect(),A=v.cloneNode(!0);Object.assign(A.style,{position:"absolute",left:`${S.left}px`,top:`${S.top}px`,zIndex:"1000",pointerEvents:"none",width:`${v.offsetWidth}px`,height:`${v.offsetHeight}px`,willChange:"transform"}),document.body.appendChild(A),v&&(v.style.visibility="hidden");const z=s.move(f);z&&(Re(z),u=z),requestAnimationFrame(()=>{K(s.fen(),n);const m=document.querySelector(`[data-square=${f.to}]`)?.querySelector(".chess-piece");m&&(m.style.visibility="hidden");const O=P.left-S.left,ve=P.top-S.top,se=Math.sqrt(O*O+ve*ve),Q=I?Math.min(Math.max(se*.4,100),250):Math.min(Math.max(se*.6,120),350);A.animate([{transform:"translate(0, 0)"},{transform:`translate(${O}px, ${ve}px)`}],{duration:Q,easing:"cubic-bezier(0.2, 1, 0.3, 1)",fill:"forwards"}).onfinish=()=>{A.style.willChange="auto",document.body.removeChild(A),m&&(m.style.visibility="visible"),Fe(),Me(),Be()||_e()}})}function kt(f){return!X||!oe?void 0:(X.style.display="flex",oe.innerHTML="",[{type:"q",name:"Queen"},{type:"r",name:"Rook"},{type:"b",name:"Bishop"},{type:"n",name:"Knight"}].forEach((E,v)=>{const S=f==="w"?E.type.toUpperCase():E.type,P=document.createElement("img");P.src=h[S],P.classList.add("promotion-piece"),P.dataset.piece=E.type,P.setAttribute("aria-label",`Promote to ${E.name}`),P.setAttribute("tabindex","0"),P.setAttribute("role","button"),P.addEventListener("keydown",A=>{(A.key==="Enter"||A.key===" ")&&(A.preventDefault(),P.click())}),oe.appendChild(P),v===0&&setTimeout(()=>P.focus(),0)}),new Promise(E=>{const v=S=>{S.target.classList.contains("promotion-piece")&&(X.style.display="none",oe.removeEventListener("click",v),E(S.target.dataset.piece))};oe.addEventListener("click",v)}))}Se.addEventListener("click",Ie),pt.addEventListener("click",Ie),te.addEventListener("click",()=>{V&&V.classList.contains("visible")||(i=i==="w"?"b":"w",n=i==="w"?"white":"black",Ye(),K(s.fen(),n),setTimeout(()=>{_e()},0))}),de.addEventListener("click",()=>{if(g){if(s.history().length<1)return;s.undo(),u=s.history({verbose:!0}).pop()||null,i=i==="w"?"b":"w"}else{if(s.history().length<2)return;B.stop(),s.undo(),s.undo(),u=s.history({verbose:!0}).pop()||null,B.setPosition("fen "+s.fen())}_e()}),re.addEventListener("click",()=>{s.turn()!==i&&!g&&!s.isGameOver()&&B.stop(),re.disabled=!0});function et(f){let o="";f<1600?o="Beginner":f<2400?o="Expert":o="Grandmaster",He.textContent=o}ae.addEventListener("input",f=>{const o=parseInt(f.target.value,10);d=o,et(o),B.setOption("UCI_Elo",o)}),ae.addEventListener("change",()=>{Be()||_e(),G()}),we.addEventListener("change",f=>{g=f.target.checked,Te.forEach(o=>o.style.opacity=g?"0.5":"1"),Te.forEach(o=>o.style.pointerEvents=g?"none":"auto"),K(s.fen(),n),G()});const tt=document.getElementById("auto-queen-toggle");tt&&tt.addEventListener("change",G);const st=document.getElementById("highlight-moves-toggle");st&&st.addEventListener("change",G),ge&&ge.addEventListener("click",()=>{confirm("Are you sure you want to reset all settings to default?")&&(localStorage.removeItem("sereneChessSettings"),location.reload())}),$e.addEventListener("change",f=>{b=f.target.checked,G()}),me.addEventListener("change",f=>{document.body.classList.toggle("dark-mode",f.target.checked),G()}),pe.addEventListener("change",f=>{$=f.target.checked,G()}),qe.addEventListener("click",()=>{ke.style.display=ke.style.display==="block"?"none":"block"}),document.addEventListener("click",f=>{!ke.contains(f.target)&&f.target!==qe&&(ke.style.display="none")});function Fe(){if(I&&!$)return;D.innerHTML="",I&&!D.classList.contains("collapsed")&&(D.style.maxHeight=D.scrollHeight+"px");const f=s.history({verbose:!0});if(f.length===0){D.innerHTML='<div style="text-align: center; color: var(--text-tertiary); padding: var(--space-lg) 0; font-style: italic;">Game moves will appear here</div>',de.disabled=!0;return}const o=document.createDocumentFragment();let E=null;f.forEach((v,S)=>{const P=Math.floor(S/2)+1;if(S%2===0){E=document.createElement("div"),E.classList.add("move-pair"),E.innerHTML=`<div class="move-number">${P}.</div>`;const L=document.createElement("span");L.classList.add("move"),L.textContent=v.san,E.appendChild(L);const m=document.createElement("span");m.classList.add("move"),E.appendChild(m),o.appendChild(E)}else E&&(E.children[2].textContent=v.san);const z=S;E&&(E.onclick=()=>{const L=new Nt;for(let m=0;m<=z;m++)L.move(f[m]);K(L.fen())})}),D.appendChild(o),de.disabled=g?f.length<1:f.length<2}function Me(){const f={p:8,n:2,b:2,r:2,q:1,k:1},o={w:{p:0,n:0,b:0,r:0,q:0,k:0},b:{p:0,n:0,b:0,r:0,q:0,k:0}};s.board().flat().forEach(L=>{L&&o[L.color][L.type]++});const E=[],v=[];let S=0,P=0;const A=["q","r","b","n","p"];for(const L of A){const m=f[L]-o.b[L];m>0&&E.push({type:L,color:"b",count:m}),P+=t[L]*o.b[L];const O=f[L]-o.w[L];O>0&&v.push({type:L,color:"w",count:O}),S+=t[L]*o.w[L]}const z=S-P;nt(dt,v,-z),nt(We,E,z)}function nt(f,o,E){if(f.innerHTML="",o.sort((v,S)=>t[S.type]-t[v.type]),o.forEach(v=>{const S=v.color==="w"?v.type.toUpperCase():v.type.toLowerCase(),P=document.createElement("img");if(P.src=h[S],P.alt=`${v.count} ${v.color==="w"?"White":"Black"} ${v.type} piece${v.count>1?"s":""}`,P.title=`${v.count} ${v.color==="w"?"White":"Black"} ${v.type} piece${v.count>1?"s":""} captured`,f.appendChild(P),v.count>1){const A=document.createElement("span");A.className="captured-piece-count",A.textContent=`x${v.count}`,f.appendChild(A)}}),E!==0){const v=document.createElement("span");v.className="material-advantage",v.textContent=E>0?`+${E}`:`${E}`,f.appendChild(v)}}function wt(){V&&V.classList.add("visible"),W&&(W.textContent="Thinking..."),re&&(re.disabled=!1),te&&(te.disabled=!0)}function De(){clearTimeout(_),V&&V.classList.remove("visible"),!s.isGameOver()&&!$?W&&(W.textContent="Ready"):s.isGameOver()&&W&&(W.textContent="Game Over"),re&&(re.disabled=!0),te&&(te.disabled=!1)}function xe(f,o="w"){he&&requestAnimationFrame(()=>{if(Ce.textContent="",he.title=`Evaluation: ${f.value}`,f.type==="mate"){const E=f.value*(o==="w"?1:-1);Ce.textContent=`M${Math.abs(E)}`,ee.style.transform=`scaleY(${E>0?1:0})`,ee.style.background=E>0?"var(--success)":"var(--danger)"}else{const E=f.value*(o==="w"?1:-1),v=Math.max(0,Math.min(1,.5+E/100*.5));ee.style.transform=`scaleY(${v})`,ee.style.background="var(--text-primary)"}})}function $t(f){f.darkMode?(document.body.classList.add("dark-mode"),me.checked=!0):(document.body.classList.remove("dark-mode"),me.checked=!1),$e.checked=f.soundEnabled,b=f.soundEnabled;const o=document.getElementById("auto-queen-toggle");o&&(o.checked=f.autoQueen);const E=document.getElementById("highlight-moves-toggle");E&&(E.checked=f.highlightMoves),g=f.humanMode===!0,we.checked=g,Te.forEach(S=>S.style.opacity=g?"0.5":"1"),Te.forEach(S=>S.style.pointerEvents=g?"none":"auto"),g&&(B.stop(),De()),pe.checked=f.trainingMode,$=f.trainingMode,d=f.elo,ae.value=f.elo,et(f.elo),p=f.contempt;const v=Object.keys(e).find(S=>e[S].contempt===p);ht.forEach(S=>S.classList.toggle("active",S.dataset.preset===(v||"balanced")))}function a(){return{version:Ae,darkMode:!1,soundEnabled:!1,autoQueen:!1,highlightMoves:!0,humanMode:!1,trainingMode:!1,elo:1800,contempt:0}}function G(){const f={version:Ae,darkMode:me.checked,soundEnabled:$e.checked,autoQueen:document.getElementById("auto-queen-toggle")?.checked||!1,highlightMoves:document.getElementById("highlight-moves-toggle")?.checked||!1,humanMode:we.checked,trainingMode:pe.checked,elo:ae.value,contempt:p};try{localStorage.setItem("sereneChessSettings",JSON.stringify(f))}catch(o){console.error("Failed to save settings to localStorage:",o),alert("Your browser is blocking local storage. Settings may not be saved.")}}function Y(){let f=a();const o=localStorage.getItem("sereneChessSettings");if(o)try{const E=JSON.parse(o);E.version===Ae?f={...f,...E}:console.warn(`Settings version mismatch. Saved: ${E.version||"none"}, Current: ${Ae}. Applying default settings.`)}catch(E){console.error("Error parsing saved settings, clearing and applying defaults:",E)}$t(f),G()}document.body.addEventListener("click",()=>{if(!M){ot.context=new ot.Context,ot.start(),M=!0;const f=new ot.Synth().toDestination();window._playMoveSound=o=>{try{o.flags.includes("c")?f.triggerAttackRelease("E4","8n"):o.flags.includes("k")||o.flags.includes("q")?f.triggerAttackRelease("G4","8n"):s.isCheck()||s.isCheckmate()?f.triggerAttackRelease("B4","8n"):f.triggerAttackRelease("C4","8n")}catch(E){console.warn("Could not play sound:",E)}},console.log("AudioContext started and Tone.js initialized!")}window.ChessApp={init:Ie}},{once:!0});try{B.initialize()}catch(f){console.error("Failed to initialize engine:",f),W&&(W.textContent="Engine load failed")}});
